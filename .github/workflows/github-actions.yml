name: "NugetVersionTest"

on:
  push:
    branches: ["master"]
  pull_request:
  release:
    types: ["published"]

permissions:
  contents: read

jobs:
  build-and-push:
    name: "NugetVersionTest"
    runs-on: ubuntu-latest

    permissions:
      contents: write
      packages: write

    # Use the Bash shell regardless whether the GitHub Actions runner is ubuntu-latest, macos-latest, or windows-latest
    defaults:
      run:
        shell: bash

    steps:
      # Checkout the repository to the GitHub Actions runner
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install GitVersion
        uses: gittools/actions/gitversion/setup@v0
        with:
          versionSpec: '6.x'
          includePrerelease: true
          preferLatestVersion: true

      - name: Determine Version
        uses: gittools/actions/gitversion/execute@v0

      - name: Build
        run: dotnet build --configuration Release /p:Version=${{ env.GitVersion_FullSemVer }}
      - name: Test
        run: dotnet test --configuration Release /p:Version=${{ env.GitVersion_FullSemVer }} --no-build
      - name: Pack
        run: dotnet pack --configuration Release /p:Version=${{ env.GitVersion_FullSemVer }} --no-build --output .
      - name: Push
        run: dotnet nuget push "NugetVersionTest.${{ env.GitVersion_FullSemVer }}.nupkg" --source "https://nuget.pkg.github.com/vRune4/index.json" --api-key ${{ secrets.GITHUB_TOKEN }}

      - name: Bump version and push tag
        uses: mathieudutour/github-tag-action@v6.1
        with:
            github_token: ${{ secrets.GITHUB_TOKEN }}
            custom_tag: ${{ env.GitVersion_FullSemVer }}
